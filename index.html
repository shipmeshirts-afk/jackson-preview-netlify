// netlify/functions/generate.js
// Uses OpenAI Images if OPENAI_API_KEY is set, else falls back to placeholder URLs.

const SIZE_MAP = new Set(["1024x1024", "1024x1536", "1536x1024", "512x512", "2048x2048"]);

exports.handler = async (event) => {
  try {
    const isGet = event.httpMethod === "GET";
    const params = isGet ? (event.queryStringParameters || {}) : JSON.parse(event.body || "{}");

    let prompt = (params.prompt || "").toString().trim();
    const style  = (params.style  || "").toString().trim();
    const size   = SIZE_MAP.has((params.size || "").toString()) ? params.size.toString() : "1024x1024";
    const seed   = (params.seed   || "").toString().trim();

    const [w, h] = size.split("x").map(n => parseInt(n, 10) || 1024);

    // ----- If OPENAI key is present, try real AI generation -----
    const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
    if (OPENAI_API_KEY && prompt) {
      // steer toward logo-like outputs
      const guidedPrompt = `${prompt} â€” ${style || "clean vector logo"}, flat colors, high contrast, simple shapes, crisp edges, no background, centered mark`;

      try {
        const resp = await fetch("https://api.openai.com/v1/images/generations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: "gpt-image-1",         // OpenAI image model
            prompt: guidedPrompt,
            size: `${w}x${h}`,
            n: 1,
            response_format: "b64_json",
            // background: "transparent"  // uncomment if supported in your plan
          })
        });

        if (!resp.ok) {
          const msg = await resp.text();
          throw new Error(`OpenAI error ${resp.status}: ${msg}`);
        }

        const data = await resp.json();
        const b64 = data?.data?.[0]?.b64_json;
        if (b64) {
          // Return a data URL that <img> can load directly
          return {
            statusCode: 200,
            headers: { "Content-Type": "application/json", "Cache-Control": "no-store" },
            body: JSON.stringify({ dataUrl: `data:image/png;base64,${b64}` })
          };
        }
      } catch (e) {
        // fall through to placeholder if AI fails
        console.error("OpenAI generation failed:", e.message);
      }
    }

    // ----- Placeholder (what you have today) -----
    const query = encodeURIComponent(`${prompt} ${style}`.trim() || "logo");
    const unsplash = `https://source.unsplash.com/${w}x${h}/?${query}${seed ? `&sig=${seed}` : ""}`;
    const proxied  = `https://images.weserv.nl/?url=${encodeURIComponent(unsplash.replace(/^https?:\/\//,''))}`;
    const fallback = `https://picsum.photos/seed/${encodeURIComponent((prompt || "logo") + (seed ? "-" + seed : ""))}/${w}/${h}`;

    return {
      statusCode: 200,
      headers: { "Content-Type": "application/json", "Cache-Control": "no-store" },
      body: JSON.stringify({ url: proxied, fallback })
    };

  } catch (err) {
    return { statusCode: 400, body: err?.message || "Bad Request" };
  }
};
