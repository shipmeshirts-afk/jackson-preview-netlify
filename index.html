<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Design Prompt Previewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Allow external images + inline script so previews load everywhere -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' https: data: blob:;
                 img-src * data: blob:;">
</head>

<body class="bg-gray-100 text-gray-900 p-6">
  <div class="max-w-4xl mx-auto space-y-6">
    <h1 class="text-3xl font-bold">Design Prompt Previewer</h1>

    <label class="flex items-center space-x-2">
      <input id="demoMode" type="checkbox" class="h-4 w-4" />
      <span>Demo mode (no backend)</span>
    </label>

    <textarea id="prompt" class="w-full p-3 rounded border" rows="3"
      placeholder="Enter design prompt..."></textarea>

    <div class="grid grid-cols-3 gap-3">
      <select id="style" class="p-3 border rounded">
        <option>Clean vector logo</option>
        <option>Bold mascot logo</option>
        <option>Realistic patch engraving</option>
      </select>

      <select id="size" class="p-3 border rounded">
        <option>1024x1024</option>
        <option>512x512</option>
        <option>2048x2048</option>
      </select>

      <input id="seed" class="p-3 border rounded" placeholder="Seed (optional)" />
    </div>

    <button id="generateBtn"
      class="px-6 py-3 bg-black text-white rounded hover:bg-gray-800">
      Generate
    </button>

    <div class="border bg-white rounded h-[500px] flex items-center justify-center">
      <img id="preview" src="" class="max-h-full max-w-full"
           alt="Preview" referrerpolicy="no-referrer" />
    </div>

    <p id="openLinkWrap" class="text-xs text-blue-700 underline text-center hidden">
      <a id="openLink" href="#" target="_blank" rel="noreferrer">Open image in a new tab</a>
    </p>

    <p class="text-xs text-gray-500 text-center">
      Previews are for concepting only. Final production artwork will be prepared by Jackson Signs &amp; T-Shirts.
    </p>
  </div>

<script>
(function () {
  const btn = document.getElementById("generateBtn");
  const img = document.getElementById("preview");
  const openWrap = document.getElementById("openLinkWrap");
  const openLink = document.getElementById("openLink");

  // Helper: show link under the preview
  function showOpenLink(url) {
    if (!url) { openWrap.classList.add("hidden"); return; }
    openLink.href = url;
    openWrap.classList.remove("hidden");
  }

  btn.addEventListener("click", async () => {
    const demoMode = document.getElementById("demoMode").checked;
    const prompt = document.getElementById("prompt").value.trim();
    const style = document.getElementById("style").value;
    const size = document.getElementById("size").value;
    const seed = (document.getElementById("seed").value || "").trim();

    img.src = "";
    img.removeAttribute("data-fallback");
    showOpenLink("");

    if (!prompt) {
      alert("Enter a prompt first");
      return;
    }

    // DEMO MODE: client-side Unsplash Source with Picsum fallback
    if (demoMode) {
      const primary = `https://source.unsplash.com/${size}/?${encodeURIComponent(prompt)}`;
      const demoFallback = `https://picsum.photos/seed/${encodeURIComponent((prompt || "logo") + (seed ? "-" + seed : ""))}/${size.replace("x","/")}`;

      // set fallback before setting src so onerror can use it
      img.setAttribute("data-fallback", demoFallback);
      img.onerror = () => {
        const fb = img.getAttribute("data-fallback");
        if (fb && img.src !== fb) img.src = fb;
      };

      img.src = primary;
      showOpenLink(primary);
      return;
    }

    // LIVE MODE: call Netlify function
    try {
      const res = await fetch(
        `/.netlify/functions/generate?prompt=${encodeURIComponent(prompt)}&style=${encodeURIComponent(style)}&size=${encodeURIComponent(size)}&seed=${encodeURIComponent(seed)}`
      );
      const data = await res.json();

      const primaryUrl = data.url;
      const fallbackUrl = data.fallback;

      // set fallback first so onerror can switch
      if (fallbackUrl) img.setAttribute("data-fallback", fallbackUrl);

      img.onerror = () => {
        const fb = img.getAttribute("data-fallback");
        if (fb && img.src !== fb) {
          img.src = fb;
          showOpenLink(fb);
        }
      };

      img.src = primaryUrl || fallbackUrl || "";
      showOpenLink(primaryUrl || fallbackUrl || "");
    } catch (err) {
      alert("Error contacting generator: " + (err?.message || err));
    }
  });
})();
</script>

</body>
</html>
