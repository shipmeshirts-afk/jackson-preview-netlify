<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Design Prompt Previewer — Jackson Signs</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https: data: blob:; img-src * data: blob:;">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html, body { height: 100%; }</style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState } = React;

    function PromptPreviewer() {
      const [prompt, setPrompt] = useState("");
      const [style, setStyle] = useState("Clean vector logo");
      const [size, setSize] = useState("1024x1024");
      const [seed, setSeed] = useState("");
      const [imgUrl, setImgUrl] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [demoMode, setDemoMode] = useState(false);

      const presets = [
        "Clean vector logo",
        "Construction company badge",
        "School mascot crest",
        "Vintage script mark",
        "Modern minimal brand",
        "Cute cartoon character",
      ];

      const sizeToDims = {
        "1024x1024": [1024, 1024],
        "1024x1536": [1024, 1536],
        "1536x1024": [1536, 1024],
      };

      async function handleGenerate() {
        setError(null);
        setImgUrl(null);

        if (!prompt.trim()) {
          setError("Please enter a design prompt.");
          return;
        }

        if (demoMode) {
          const [w, h] = sizeToDims[size] || [1024, 1024];
          const keywords = encodeURIComponent((prompt + " " + style).replace(/\s+/g, " ").trim());
          const url = `https://source.unsplash.com/${w}x${h}/?${keywords}&sig=${seed || Math.floor(Math.random()*1e9)}`;
          setImgUrl(url);
          return;
        }

        try {
          setLoading(true);
          const res = await fetch("/.netlify/functions/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, style, size, seed })
          });
          const txt = await res.text();
          if (!res.ok) throw new Error(txt || ("Server error " + res.status));
          let data;
          try { data = JSON.parse(txt); } catch(e) { throw new Error("Bad JSON from backend: " + txt.slice(0,120)); }
          if (!data || !data.url) throw new Error("No image URL in response");
          setImgUrl(data.url);
        } catch (e) {
          setError(e?.message || "Something went wrong generating your design.");
        } finally {
          setLoading(false);
        }
      }

      return (
        <div className="p-6 md:p-10 max-w-5xl mx-auto">
          <h1 className="text-3xl md:text-4xl font-bold mb-4">Design Prompt Previewer</h1>

          <div className="flex items-center justify-between mb-3">
            <label className="flex items-center gap-2 text-sm">
              <input type="checkbox" checked={demoMode} onChange={e => setDemoMode(e.target.checked)} />
              Demo mode (no backend)
            </label>
            <div className="text-xs text-slate-500">Size: {size}</div>
          </div>

          <textarea
            className="w-full border rounded-xl p-3 min-h-[120px] mb-3"
            placeholder="Describe the design you want… e.g., 'retro fishing charter badge with tarpon and palm tree'"
            value={prompt}
            onChange={(e) => setPrompt(e.target.value)}
          />

          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <select className="w-full rounded-xl border border-slate-300 p-2" value={style} onChange={(e)=>setStyle(e.target.value)}>
              {presets.map(p => <option key={p} value={p}>{p}</option>)}
            </select>
            <select className="w-full rounded-xl border border-slate-300 p-2" value={size} onChange={(e)=>setSize(e.target.value)}>
              <option>1024x1024</option>
              <option>1024x1536</option>
              <option>1536x1024</option>
            </select>
            <input className="w-full rounded-xl border border-slate-300 p-2" type="number" inputMode="numeric" placeholder="Seed (optional)" value={seed} onChange={(e)=>setSeed(e.target.value)} />
          </div>
          <button onClick={handleGenerate} disabled={loading} className="px-6 py-3 bg-black text-white rounded-xl mb-4 disabled:opacity-60">
            {loading ? "Generating..." : "Generate"}
          </button>
          {error && <div className="text-red-600 mb-3 text-sm bg-red-50 border border-red-200 rounded-lg p-3">{error}</div>}
          <div className="border rounded-xl bg-slate-100 p-4 min-h-[400px] grid place-items-center">
            {imgUrl
              ? <img src={imgUrl} referrerPolicy="no-referrer" className="max-h-full max-w-full" alt="Preview" />
              : "Your preview will appear here."}
          </div>
          {imgUrl && <div className="mt-2 text-xs"><a href={imgUrl} target="_blank" rel="noreferrer" className="underline">Open image in a new tab</a></div>}
          <p className="text-xs text-slate-500 mt-4">Previews are for concepting only. Final production artwork will be prepared by Jackson Signs & T‑Shirts.</p>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<PromptPreviewer />);
  </script>
</body>
</html>
