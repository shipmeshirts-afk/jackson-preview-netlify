<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Design Prompt Previewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-900 p-6">
  <div class="max-w-5xl mx-auto space-y-6">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-3xl font-bold">Design Prompt Previewer</h1>
      <label class="flex items-center gap-2 text-sm">
        <input id="demoMode" type="checkbox" class="h-4 w-4" />
        <span>Demo mode (no backend)</span>
      </label>
    </div>

    <textarea id="prompt" class="w-full p-3 rounded border bg-white" rows="3"
      placeholder="Describe the designâ€¦ e.g., 'donkey wearing sunglasses vector logo, bold, high-contrast'"></textarea>

    <!-- Presets -->
    <div class="grid md:grid-cols-2 gap-3">
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-gray-600 mr-1">Style:</span>
        <button data-style="Clean vector logo" class="preset-btn px-3 py-2 rounded border bg-white hover:bg-gray-50">Clean vector</button>
        <button data-style="Bold mascot logo" class="preset-btn px-3 py-2 rounded border bg-white hover:bg-gray-50">Mascot</button>
        <button data-style="Realistic patch engraving" class="preset-btn px-3 py-2 rounded border bg-white hover:bg-gray-50">Patch/engraving</button>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium text-gray-600 mr-1">Preset prompts:</span>
        <button data-prompt="Minimal clean vector logo, simple geometric shapes, centered mark" class="prompt-btn px-3 py-2 rounded border bg-white hover:bg-gray-50">Minimal mark</button>
        <button data-prompt="Aggressive sports mascot logo, thick outlines, dynamic pose" class="prompt-btn px-3 py-2 rounded border bg-white hover:bg-gray-50">Sports mascot</button>
        <button data-prompt="Vintage badge logo for construction company, stencil feel, bold typography" class="prompt-btn px-3 py-2 rounded border bg-white hover:bg-gray-50">Construction badge</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="grid md:grid-cols-4 gap-3">
      <select id="style" class="p-3 border rounded bg-white">
        <option>Clean vector logo</option>
        <option>Bold mascot logo</option>
        <option>Realistic patch engraving</option>
      </select>

      <select id="size" class="p-3 border rounded bg-white">
        <!-- Square + Portrait + Landscape: all supported by your function -->
        <option>1024x1024</option>
        <option>1536x1024</option>
        <option>1024x1536</option>
        <option>512x512</option>
        <option>2048x1024</option>
        <option>1024x2048</option>
      </select>

      <input id="seed" class="p-3 border rounded bg-white" placeholder="Seed (optional)" />

      <div class="flex gap-2">
        <button id="generateBtn" class="flex-1 px-4 py-3 bg-black text-white rounded hover:bg-gray-800">
          Generate
        </button>
        <button id="randomSeedBtn" class="px-4 py-3 border rounded bg-white hover:bg-gray-50" title="Randomize seed">ðŸŽ²</button>
      </div>
    </div>

    <!-- Viewer Toolbar -->
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm text-gray-600">
        <span id="status" class="hidden">Generatingâ€¦</span>
        <span id="error" class="hidden text-red-600"></span>
      </div>
      <div class="flex items-center gap-2">
        <button id="openBtn" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 disabled:opacity-40" disabled>Open in new tab</button>
        <button id="downloadBtn" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 disabled:opacity-40" disabled>Download</button>
      </div>
    </div>

    <!-- Preview -->
    <div class="border bg-white rounded h-[560px] flex items-center justify-center relative overflow-hidden">
      <div id="spinner" class="hidden absolute inset-0 flex items-center justify-center bg-white/50">
        <svg class="animate-spin h-8 w-8 text-gray-700" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
      </div>
      <img id="preview" src="" alt="Preview" class="max-h-full max-w-full object-contain select-none" />
    </div>

    <p class="text-xs text-gray-500 text-center">
      Previews are for concepting only. Final production artwork will be prepared by Jackson Signs &amp; T-Shirts.
    </p>
  </div>

<script>
  const qs = id => document.getElementById(id);
  const preview = qs('preview');
  const statusEl = qs('status');
  const errorEl = qs('error');
  const spinner = qs('spinner');
  const openBtn = qs('openBtn');
  const downloadBtn = qs('downloadBtn');

  // Preset buttons
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      qs('style').value = btn.dataset.style;
    });
  });
  document.querySelectorAll('.prompt-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = qs('prompt');
      p.value = btn.dataset.prompt;
      p.focus();
    });
  });

  // Randomize seed
  qs('randomSeedBtn').addEventListener('click', () => {
    qs('seed').value = Math.floor(Math.random() * 1e9);
  });

  // Helper: enable/disable actions
  function setReady(url) {
    openBtn.disabled = !url;
    downloadBtn.disabled = !url;
    if (url) {
      openBtn.onclick = () => window.open(url, '_blank');
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = 'preview.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
      };
    } else {
      openBtn.onclick = null;
      downloadBtn.onclick = null;
    }
  }

  async function generate() {
    const demoMode = qs('demoMode').checked;
    const prompt = qs('prompt').value.trim();
    const style = qs('style').value;
    const size = qs('size').value;
    const seed = qs('seed').value.trim();

    if (!prompt) {
      alert('Enter a prompt first');
      return;
    }

    // UI state
    errorEl.classList.add('hidden');
    errorEl.textContent = '';
    statusEl.textContent = 'Generatingâ€¦';
    statusEl.classList.remove('hidden');
    spinner.classList.remove('hidden');
    preview.src = '';
    setReady(null);

    try {
      let url;

      if (demoMode) {
        // Unsplash demo fallback (random, non-deterministic).
        url = `https://source.unsplash.com/${size}/?${encodeURIComponent(prompt)}`;
      } else {
        // Hit Netlify function
        const params = new URLSearchParams({
          prompt,
          style,
          size,
          seed
        });
        const resp = await fetch(`/.netlify/functions/generate?${params.toString()}`);
        if (!resp.ok) {
          const t = await resp.text().catch(() => '');
          throw new Error(`Backend error ${resp.status}: ${t || resp.statusText}`);
        }
        const data = await resp.json();
        // Prefer embedded data URL â†’ proxy URL â†’ fallback
        url = data.dataUrl || data.url || data.fallback;
        if (!url) throw new Error('No image URL returned from backend.');
      }

      preview.onload = () => {
        spinner.classList.add('hidden');
        statusEl.classList.add('hidden');
        setReady(preview.src);
      };
      preview.onerror = () => {
        spinner.classList.add('hidden');
        statusEl.classList.add('hidden');
        setReady(null);
        errorEl.textContent = 'Failed to load the generated image. Try a different prompt or size.';
        errorEl.classList.remove('hidden');
      };

      preview.src = url;
    } catch (err) {
      spinner.classList.add('hidden');
      statusEl.classList.add('hidden');
      setReady(null);
      errorEl.textContent = err.message || 'Something went wrong.';
      errorEl.classList.remove('hidden');
    }
  }

  qs('generateBtn').addEventListener('click', generate);
</script>

</body>
</html>
